<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style type="text/css">
        .autocomplete-div {
            border: 1px solid black;
        }
        .autocompletion {
            background-color: #ccc;
            display: inline-block;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <textarea class="autocomplete">Lorem ipsum dolor</textarea>
    <script>
        function getCaretPosition(element) {
            var caretOffset = 0;
            var doc = element.ownerDocument || element.document;
            var win = doc.defaultView || doc.parentWindow;
            var sel;
            if (typeof win.getSelection != "undefined") {
                sel = win.getSelection();
                if (sel.rangeCount > 0) {
                    var range = win.getSelection().getRangeAt(0);
                    var preCaretRange = range.cloneRange();
                    preCaretRange.selectNodeContents(element);
                    preCaretRange.setEnd(range.endContainer, range.endOffset);
                    caretOffset = preCaretRange.toString().length;
                }
            } else if ( (sel = doc.selection) && sel.type != "Control") {
                var textRange = sel.createRange();
                var preCaretTextRange = doc.body.createTextRange();
                preCaretTextRange.moveToElementText(element);
                preCaretTextRange.setEndPoint("EndToEnd", textRange);
                caretOffset = preCaretTextRange.text.length;
            }
            return caretOffset;
        }

        function do_autocomplete( div ) {
            // get cursror position
            let position = getCaretPosition( div ) - 1;
            position = position < 0 ? 0 : position;
            const char = div.textContent[position];

            console.log( position, char );

            div.querySelector( ".autocompletion" )?.remove();

            if( char === " " || char === "Â " ) {
                console.log( "adding autocompletion" );

                const sel = window.getSelection();
                if (sel.rangeCount > 0) {
                    const range = sel.getRangeAt(0);

                    const autocompletion = "this is a test";
                    const autocompletion_container = document.createElement( "span" );
                    autocompletion_container.classList.add( "autocompletion" );
                    autocompletion_container.textContent = autocompletion;
                    autocompletion_container.contentEditable = false;
                    range.insertNode(autocompletion_container);

                    range.setStartBefore(autocompletion_container);
                    range.setEndBefore(autocompletion_container);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            } else {
                console.log( "removed autocompletion ("+char+")" );
            }
        }

        function init_autocomplete( element ) {
            const div = document.createElement( "div" );
            div.classList.add( "autocomplete-div" );
            div.contentEditable = true;
            div.textContent = element.value;

            div.addEventListener( "keyup", function(e) {
                if( ! e.ctrlKey && ! e.altKey && ! e.shiftKey && ! e.metaKey ) {
                    do_autocomplete( this );
                }
            } );

            document.body.appendChild( div );
        }

        document.querySelectorAll(".autocomplete").forEach( e => {
            init_autocomplete( e );
        } );
    </script>
</body>
</html>