<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style type="text/css">
        .autocompletion {
            background-color: #ccc;
            display: inline-block;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <form action="">
        <textarea name="message" class="autocomplete" cols="25">Lorem ipsum dolor</textarea><br />
        <button>Submit</button>
    </form>
    <script>
        const autocompletion_list = [
            "Sorry for the late reply",
            "I'm sorry, I don't understand",
            "Let me know if you need any help",
            "Let me know what you think",
        ];

        function get_autocompletion( text ) {
            text = text.toLowerCase();
            text = text.replace( /\s/g, " " );

            for( let sentence of autocompletion_list ) {
                sentence = sentence.toLowerCase();

                for( let i = 0; i <= sentence.length*0.6; i++ ) {
                    const start = sentence.slice( 0, sentence.length-i );
                    const end = sentence.slice( sentence.length-i, sentence.length );

                    if( text.endsWith( start ) ) {
                        return end;
                    }
                }
            }

            return null;
        }

        function getCaretPosition(element) {
            var caretOffset = 0;
            var doc = element.ownerDocument || element.document;
            var win = doc.defaultView || doc.parentWindow;
            var sel;
            if (typeof win.getSelection != "undefined") {
                sel = win.getSelection();
                if (sel.rangeCount > 0) {
                    var range = win.getSelection().getRangeAt(0);
                    var preCaretRange = range.cloneRange();
                    preCaretRange.selectNodeContents(element);
                    preCaretRange.setEnd(range.endContainer, range.endOffset);
                    caretOffset = preCaretRange.toString().length;
                }
            } else if ( (sel = doc.selection) && sel.type != "Control") {
                var textRange = sel.createRange();
                var preCaretTextRange = doc.body.createTextRange();
                preCaretTextRange.moveToElementText(element);
                preCaretTextRange.setEndPoint("EndToEnd", textRange);
                caretOffset = preCaretTextRange.text.length;
            }
            return caretOffset;
        }

        function do_autocomplete( div, textarea ) {
            div.querySelector( ".autocompletion" )?.remove();

            textarea.value = div.textContent;

            // get cursror position
            const position = getCaretPosition( div );
            const text = div.textContent.slice( 0, position );

            const autocompletion = get_autocompletion( text );

            if( autocompletion ) {
                console.log( "adding autocompletion" );

                const sel = window.getSelection();
                if (sel.rangeCount > 0) {
                    const range = sel.getRangeAt(0);

                    const autocompletion_container = document.createElement( "span" );
                    autocompletion_container.classList.add( "autocompletion" );
                    autocompletion_container.textContent = autocompletion.replace( / /g, "\u00a0" );
                    autocompletion_container.contentEditable = false;
                    range.insertNode(autocompletion_container);

                    range.setStartBefore(autocompletion_container);
                    range.setEndBefore(autocompletion_container);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            } else {
                console.log( "removed autocompletion" );
            }
        }

        function init_autocomplete( element ) {
            const div = document.createElement( "div" );
            div.classList.add( "autocomplete-div" );
            div.contentEditable = true;
            div.textContent = element.value;

            div.addEventListener( "keyup", function(e) {
                if( ! e.ctrlKey && ! e.altKey && ! e.shiftKey && ! e.metaKey ) {
                    do_autocomplete( this, element );
                }
            } );

            div.style.width = element.offsetWidth + "px";
            div.style.height = element.offsetHeight + "px";

            // copy the border of the textarea
            div.style.border = window.getComputedStyle( element ).border;
            div.style.borderRadius = window.getComputedStyle( element ).borderRadius; // TODO: doesn't work

            element.insertAdjacentElement( "afterend", div );
            element.style.display = "none";
        }

        document.querySelectorAll(".autocomplete").forEach( e => {
            init_autocomplete( e );
        } );
    </script>
</body>
</html>