<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style type="text/css">
        .autocomplete-div {
            border: 1px solid black;
        }
        .autocompletion {
            background-color: #ccc;
            display: inline-block;
        }
    </style>
</head>
<body>
    <textarea class="autocomplete">Lorem ipsum dolor</textarea>
    <script>
        function setCaretPosition(element, position) {
            var range = document.createRange();
            var sel = window.getSelection();
            range.setStart(element.childNodes[0], 1);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
            element.focus();
        }

        function getCaretPosition(element) {
            var caretOffset = 0;
            var doc = element.ownerDocument || element.document;
            var win = doc.defaultView || doc.parentWindow;
            var sel;
            if (typeof win.getSelection != "undefined") {
                sel = win.getSelection();
                if (sel.rangeCount > 0) {
                    var range = win.getSelection().getRangeAt(0);
                    var preCaretRange = range.cloneRange();
                    preCaretRange.selectNodeContents(element);
                    preCaretRange.setEnd(range.endContainer, range.endOffset);
                    caretOffset = preCaretRange.toString().length;
                }
            } else if ( (sel = doc.selection) && sel.type != "Control") {
                var textRange = sel.createRange();
                var preCaretTextRange = doc.body.createTextRange();
                preCaretTextRange.moveToElementText(element);
                preCaretTextRange.setEndPoint("EndToEnd", textRange);
                caretOffset = preCaretTextRange.text.length;
            }
            return caretOffset;
        }

        function do_autocomplete( div ) {
            // get cursror position
            let position = getCaretPosition( div ) - 1;
            position = position < 0 ? 0 : position;
            const char = div.textContent[position];

            console.log( position, char );

            if( char === " " || char === "Â " ) {
                if( div.querySelectorAll( ".autocompletion" ).length ) {
                    return;
                }

                console.log( "adding autocompletion" );
                const start = div.textContent.slice( 0, position + 1 );
                const end = div.textContent.slice( position );

                div.querySelector(".end-container")?.remove();

                const spans = div.querySelectorAll("span");
                if( spans.length ) {
                    const start_container = div.querySelectorAll("span")[0];
                    start_container.textContent = start;
                } else {
                    div.textContent = "";
                    const start_container = document.createElement( "span" );
                    start_container.textContent = start;
                    div.appendChild( start_container );
                }

                const autocompletion = "this is a test";

                const autocompletion_container = document.createElement( "span" );
                autocompletion_container.classList.add( "autocompletion" );
                autocompletion_container.textContent = autocompletion;
                autocompletion_container.contentEditable = false;
                div.appendChild( autocompletion_container );

                const end_container = document.createElement( "span" );
                end_container.classList.add( "end-container" );
                end_container.textContent = end;
                div.appendChild( end_container );

                setCaretPosition( div, position + 1 );
            } else {
                console.log( "removed autocompletion ("+char+")" );
                div.querySelectorAll( ".autocompletion" ).forEach( e => {
                    e.remove();
                    div.querySelector(".end-container").textContent = div.querySelector(".end-container").textContent.slice( 1 );
                } );
            }
        }

        function init_autocomplete( element ) {
            const div = document.createElement( "div" );
            div.classList.add( "autocomplete-div" );
            div.contentEditable = true;

            const start_container = document.createElement( "span" );
            start_container.textContent = element.value;
            div.appendChild( start_container );

            div.addEventListener( "keyup", function(e) {
                if( ! e.ctrlKey && ! e.altKey && ! e.shiftKey && ! e.metaKey ) {
                    do_autocomplete( this );
                }
            } );

            document.body.appendChild( div );
        }

        document.querySelectorAll(".autocomplete").forEach( e => {
            init_autocomplete( e );
        } );
    </script>
</body>
</html>